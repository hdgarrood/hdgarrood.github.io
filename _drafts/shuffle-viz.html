---
layout: post
---

<div id="shuffleviz"></div>
<a id="next" href="#">Next</a>
<a id="prev" href="#">Prev</a>

<style>
text { color: green; }
svg { background-color: #dde; }
</style>

<script>
function deck(x, y, cards, cardHeight, maxSize) {
    return {
        type: 'deck',
        x: x,
        y: y,
        cards: cards,
        cardHeight: cardHeight,
        maxSize: maxSize,

        getTopCard: function() {
            return this.cards[0]
        },
        discardTopCard: function() {
            var clone = _.clone(this)
            clone.cards = clone.cards.slice(1)
            return clone
        },
        placeOnTop: function(card) {
            var clone = _.clone(this)
            clone.cards = [card].concat(clone.cards)
            return clone
        },
        placeOnBottom: function(card) {
            var clone = _.clone(this)
            clone.cards = clone.cards.concat([card])
            return clone
        }
    }
}

function initialState() {
    return {
        deck1: deck(40, 50, ['A', '2', '3', '4', '5'], 18, 5),
        deck2: deck(80, 50, [], 18, 5),
    }
}

function step1(state) {
    var card = state.deck1.getTopCard()
    return {
        deck1: state.deck1.discardTopCard(),
        deck2: state.deck2.placeOnTop(card)
    }
}

function step2(state) {
    var card = state.deck1.getTopCard(),
        newDeck1 = state.deck1.discardTopCard()
    return {
        deck1: newDeck1.placeOnBottom(card),
        deck2: state.deck2
    }
}

function getAllStates() {
    var state    = initialState(),
        nextStep = true,
        result   = [state],
        done     = function() {
                    return state.deck2.cards.length == 5
                   }

    while (!done()) {
        if (nextStep) {
            state = step1(state)
        } else {
            state = step2(state)
        }

        nextStep = !nextStep
        result.push(state)
    }

    return result
}

function countDownFrom(x) {
    var y = x,
        result = []

    while (y > 0) {
        result.push(y)
        y--
    }

    return result
}

function takeWhile(arr, pred) {
    var result = [],
        i      = 0

    while (i < arr.length && pred(arr[i])) {
        result.push(arr[i])
        i++
    }

    return result
}

function cardsWithPositions(deck) {
    var indices =
            countDownFrom(deck.maxSize),
        cardsWithIndices =
            takeWhile(
                _.zip(_.clone(deck.cards).reverse(), indices),
                function(x) { return x[0] != null }
            )

    return _.map(cardsWithIndices, function(pair) {
        return {
            card: pair[0],
            x: deck.x,
            y: deck.y + (pair[1] * deck.cardHeight)
        }
    })
}

function id(x) { return x }
function by(attr) { return function(x) { return x[attr] } }

function update(svg, state) {
    var allCards = cardsWithPositions(state.deck1)
                    .concat(cardsWithPositions(state.deck2))
    var cards = svg.selectAll("text")
                    .data(allCards, by("card"))

    cards.enter()
        .append("text")
        .text(by("card"))
        .attr('x', by("x"))
        .attr('y', by("y"))

    cards.transition()
        .attr('x', by("x"))
        .attr('y', by("y"))

    cards.exit().remove()
}

function hasIndex(arr, idx) {
    return idx >= 0 && idx < arr.length
}

function start() {
    var width        = 200,
        height       = 200,
        states       = getAllStates(),
        currentIndex = 0

    var svg = d3.select("#shuffleviz")
                .append("svg")
                    .attr("width", width)
                    .attr("height", height)

    function changeState(difference) {
        if (hasIndex(states, currentIndex + difference)) {
            currentIndex += difference
            update(svg, states[currentIndex])
        }
    }

    function next() {
        changeState(1)
    }

    function prev() {
        changeState(-1)
    }

    d3.select("#next")
        .on("click", next)

    d3.select("#prev")
        .on("click", prev)

    update(svg, states[currentIndex])
}

window.onload = start()
</script>
